<svg xmlns="http://www.w3.org/2000/svg" id="mermaid-1583528113554" width="100%" height="100%" viewBox="-50 -10 1450 1167.094" style="max-width:1450px"><style>#mermaid-1583528113554 .actor{stroke:#ccf;fill:#ececff}#mermaid-1583528113554 text.actor{fill:#000;stroke:none}#mermaid-1583528113554 .actor-line{stroke:gray}#mermaid-1583528113554 .messageLine0,#mermaid-1583528113554 .messageLine1{stroke-width:1.5;stroke-dasharray:&apos;2 2&apos;;stroke:#333}#mermaid-1583528113554 #arrowhead,#mermaid-1583528113554 #sequencenumber{fill:#333}#mermaid-1583528113554 #crosshead path{fill:#333!important;stroke:#333!important}#mermaid-1583528113554 .messageText{fill:#333;stroke:none}#mermaid-1583528113554 .labelBox{stroke:#ccf;fill:#ececff}#mermaid-1583528113554 .labelText,#mermaid-1583528113554 .loopText{fill:#000;stroke:none}#mermaid-1583528113554 .loopLine{stroke-width:2;stroke-dasharray:&apos;2 2&apos;;stroke:#ccf}#mermaid-1583528113554 .note{stroke:#aa3;fill:#fff5ad}#mermaid-1583528113554 .noteText{fill:#000;stroke:none;font-family:&apos;trebuchet ms&apos;,verdana,arial;font-family:var(--mermaid-font-family);font-size:14px}:root{--mermaid-font-family:&apos;&quot;trebuchet ms&quot;, verdana, arial&apos;;--mermaid-font-family:&quot;Comic Sans MS&quot;, &quot;Comic Sans&quot;, cursive;--mermaid-font-family:&quot;trebuchet ms&quot;, verdana, arial}</style><style>#mermaid-1583528113554{color:#000;font:16px &quot;trebuchet ms&quot;,verdana,arial}</style><g><line id="actor14" x1="75" x2="75" y1="5" y2="1156.094" stroke="#999" stroke-width=".5" class="actor-line"/><rect width="150" height="65" x="0" y="0" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="75" y="32.5" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="75" dy="0">User</tspan></text></g><g><line id="actor15" x1="275" x2="275" y1="5" y2="1156.094" stroke="#999" stroke-width=".5" class="actor-line"/><rect width="150" height="65" x="200" y="0" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="275" y="32.5" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="275" dy="0">BF Channel Service</tspan></text></g><g><line id="actor16" x1="475" x2="475" y1="5" y2="1156.094" stroke="#999" stroke-width=".5" class="actor-line"/><rect width="150" height="65" x="400" y="0" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="475" y="32.5" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="475" dy="0">BF Token Service</tspan></text></g><g><line id="actor17" x1="675" x2="675" y1="5" y2="1156.094" stroke="#999" stroke-width=".5" class="actor-line"/><rect width="150" height="65" x="600" y="0" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="675" y="32.5" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="675" dy="0">AS *1 Auth Endpoint</tspan></text></g><g><line id="actor18" x1="875" x2="875" y1="5" y2="1156.094" stroke="#999" stroke-width=".5" class="actor-line"/><rect width="150" height="65" x="800" y="0" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="875" y="32.5" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="875" dy="0">AS Token Endpoint</tspan></text></g><g><line id="actor19" x1="1075" x2="1075" y1="5" y2="1156.094" stroke="#999" stroke-width=".5" class="actor-line"/><rect width="150" height="65" x="1000" y="0" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="1075" y="32.5" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="1075" dy="0">Bot</tspan></text></g><g><line id="actor20" x1="1275" x2="1275" y1="5" y2="1156.094" stroke="#999" stroke-width=".5" class="actor-line"/><rect width="150" height="65" x="1200" y="0" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="1275" y="32.5" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="1275" dy="0">Protected Resource</tspan></text></g><defs><marker id="arrowhead" markerHeight="4" markerWidth="6" orient="auto" refX="5" refY="2"><path d="M 0,0 V 4 L6,2 Z"/></marker></defs><defs><marker id="crosshead" markerHeight="8" markerWidth="15" orient="auto" refX="16" refY="4"><path fill="#000" stroke="#000" stroke-width="1" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray:0,0"/><path fill="none" stroke="#000" stroke-width="1" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray:0,0"/></marker></defs><defs><marker id="sequencenumber" markerHeight="40" markerWidth="60" orient="auto" refX="15" refY="15"><circle cx="15" cy="15" r="6"/></marker></defs><g><rect width="250" height="36.016" x="650" y="75" fill="#EDF2AE" stroke="#666" class="note" rx="0" ry="0"/><text x="646" y="99" class="noteText"><tspan x="666">Authorization Server</tspan></text></g><g><rect width="250" height="36.016" x="650" y="121.016" fill="#EDF2AE" stroke="#666" class="note" rx="0" ry="0"/><text x="646" y="145.016" class="noteText"><tspan x="666">e.g. AAD, GitHub, Facebook, etc.</tspan></text></g><g><text x="175" y="185.031" class="messageText" style="text-anchor:middle">Message Activity &quot;Please check my email&quot;</text><line x1="75" x2="275" y1="192.031" y2="192.031" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine0" style="fill:none"/></g><g><text x="675" y="220.031" class="messageText" style="text-anchor:middle">Receives Msg Activity &amp; Determines intent is to check email</text><line x1="275" x2="1075" y1="227.031" y2="227.031" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine0" style="fill:none"/></g><g><text x="775" y="255.031" class="messageText" style="text-anchor:middle">Do we have Token already? (https://api.botframework.com/api/usertoken/GetToken)</text><line x1="1075" x2="475" y1="262.031" y2="262.031" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine0" style="fill:none"/></g><g><rect width="650" height="36.016" x="450" y="272.031" fill="#EDF2AE" stroke="#666" class="note" rx="0" ry="0"/><text x="446" y="296.031" class="noteText"><tspan x="466">Token for the given userId for the OAuth connection setting called &quot;GraphConnection&quot;</tspan></text></g><g><text x="775" y="361.047" class="messageText" style="text-anchor:middle">Return [Token] NotFound result</text><line x1="475" x2="1075" y1="368.047" y2="368.047" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine1" style="stroke-dasharray:3,3;fill:none"/></g><g><rect width="250" height="36.016" x="650" y="378.047" fill="#EDF2AE" stroke="#666" class="note" rx="0" ry="0"/><text x="646" y="402.047" class="noteText"><tspan x="666">Such as 1st time User interacts w/Bot</tspan></text></g><g><line x1="465" x2="1085" y1="318.047" y2="318.047" class="loopLine"/><line x1="1085" x2="1085" y1="318.047" y2="424.063" class="loopLine"/><line x1="465" x2="1085" y1="424.063" y2="424.063" class="loopLine"/><line x1="465" x2="465" y1="318.047" y2="424.063" class="loopLine"/><polygon points="465 318.047 515 318.047 515 331.047 506.6 338.047 465 338.047" class="labelBox"/><text x="472.5" y="333.047" class="labelText"><tspan x="472.5">alt</tspan></text><text x="775" y="333.047" class="loopText" style="text-anchor:middle"><tspan x="775">[ Does Not Have Token ]</tspan></text></g><g><text x="675" y="452.063" class="messageText" style="text-anchor:middle">Creates OAuthCard, asks User to sign in</text><line x1="1075" x2="275" y1="459.063" y2="459.063" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine0" style="fill:none"/></g><g><text x="375" y="487.063" class="messageText" style="text-anchor:middle">Create Valid OAuth sign-in URL for request</text><line x1="275" x2="475" y1="494.063" y2="494.063" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine0" style="fill:none"/></g><g><text x="375" y="522.063" class="messageText" style="text-anchor:middle">Valid sign-in URL added to OAuthCard</text><line x1="475" x2="275" y1="529.063" y2="529.063" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine1" style="stroke-dasharray:3,3;fill:none"/></g><g><text x="175" y="557.063" class="messageText" style="text-anchor:middle">Send Message with OAuthCard that has Sign-In Button</text><line x1="275" x2="75" y1="564.063" y2="564.063" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine0" style="fill:none"/></g><g><text x="175" y="592.063" class="messageText" style="text-anchor:middle">User clicks Sign-In button</text><line x1="75" x2="275" y1="599.063" y2="599.063" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine0" style="fill:none"/></g><g><text x="475" y="627.063" class="messageText" style="text-anchor:middle">Calls Authorization Server to load Sign-In page/pop-up</text><line x1="275" x2="675" y1="634.063" y2="634.063" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine0" style="fill:none"/></g><g><text x="375" y="662.063" class="messageText" style="text-anchor:middle">Serves Sign-In page/pop-up</text><line x1="675" x2="75" y1="669.063" y2="669.063" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine0" style="fill:none"/></g><g><text x="375" y="722.063" class="messageText" style="text-anchor:middle">User signs in &amp; authorizes Bot</text><line x1="75" x2="675" y1="729.063" y2="729.063" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine0" style="fill:none"/></g><g><text x="575" y="757.063" class="messageText" style="text-anchor:middle">Returns authorization code</text><line x1="675" x2="475" y1="764.063" y2="764.063" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine1" style="stroke-dasharray:3,3;fill:none"/></g><g><rect width="450" height="36.016" x="450" y="774.063" fill="#EDF2AE" stroke="#666" class="note" rx="0" ry="0"/><text x="446" y="798.063" class="noteText"><tspan x="466">https://token.botframework.com/.auth/web/redirect</tspan></text></g><g><text x="675" y="838.078" class="messageText" style="text-anchor:middle">Uses authorization code to obtain Token</text><line x1="475" x2="875" y1="845.078" y2="845.078" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine0" style="fill:none"/></g><g><text x="675" y="873.078" class="messageText" style="text-anchor:middle">Returns Token</text><line x1="875" x2="475" y1="880.078" y2="880.078" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine1" style="stroke-dasharray:3,3;fill:none"/></g><g><text x="475" y="908.078" class="messageText" style="text-anchor:middle">Securely stores Token</text><path stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" d="M 475,915.078125 C 535,905.078125 535,945.078125 475,935.078125" class="messageLine0" style="fill:none"/></g><g><text x="775" y="973.078" class="messageText" style="text-anchor:middle">Returns Token</text><line x1="475" x2="1075" y1="980.078" y2="980.078" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine1" style="stroke-dasharray:3,3;fill:none"/></g><g><line x1="65" x2="1085" y1="679.063" y2="679.063" class="loopLine"/><line x1="1085" x2="1085" y1="679.063" y2="990.078" class="loopLine"/><line x1="65" x2="1085" y1="990.078" y2="990.078" class="loopLine"/><line x1="65" x2="65" y1="679.063" y2="990.078" class="loopLine"/><polygon points="65 679.063 115 679.063 115 692.063 106.6 699.063 65 699.063" class="labelBox"/><text x="72.5" y="694.063" class="labelText"><tspan x="72.5">opt</tspan></text><text x="575" y="694.063" class="loopText" style="text-anchor:middle"><tspan x="575">[ Grant Type: Authorization Code *2 ]</tspan></text></g><g><text x="1175" y="1018.078" class="messageText" style="text-anchor:middle">Makes request with Token to access Protected Resource</text><line x1="1075" x2="1275" y1="1025.078" y2="1025.078" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" class="messageLine0" style="fill:none"/></g><g><rect width="250" height="36.016" x="1050" y="1035.078" fill="#EDF2AE" stroke="#666" class="note" rx="0" ry="0"/><text x="1046" y="1059.078" class="noteText"><tspan x="1066">Calls &quot;check email&quot; API</tspan></text></g><g><rect width="150" height="65" x="0" y="1091.094" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="75" y="1123.594" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="75" dy="0">User</tspan></text></g><g><rect width="150" height="65" x="200" y="1091.094" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="275" y="1123.594" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="275" dy="0">BF Channel Service</tspan></text></g><g><rect width="150" height="65" x="400" y="1091.094" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="475" y="1123.594" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="475" dy="0">BF Token Service</tspan></text></g><g><rect width="150" height="65" x="600" y="1091.094" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="675" y="1123.594" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="675" dy="0">AS *1 Auth Endpoint</tspan></text></g><g><rect width="150" height="65" x="800" y="1091.094" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="875" y="1123.594" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="875" dy="0">AS Token Endpoint</tspan></text></g><g><rect width="150" height="65" x="1000" y="1091.094" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="1075" y="1123.594" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="1075" dy="0">Bot</tspan></text></g><g><rect width="150" height="65" x="1200" y="1091.094" fill="#eaeaea" stroke="#666" class="actor" rx="3" ry="3"/><text x="1275" y="1123.594" alignment-baseline="central" class="actor" dominant-baseline="central" style="text-anchor:middle;font-size:14px"><tspan x="1275" dy="0">Protected Resource</tspan></text></g></svg>